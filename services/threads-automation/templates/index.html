<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads Automation Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .log-box { height: 400px; overflow-y: auto; background: #1e1e1e; color: #00ff00; font-family: monospace; padding: 10px; font-size: 0.85rem; }
        .config-editor { font-family: monospace; font-size: 0.85rem; min-height: 300px; background: #f8f9fa; }
        .profile-select { height: 300px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">ü§ñ Threads Automation Control</span>
            <span class="badge bg-success" id="connectionStatus">Connected</span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row">
            <!-- Left Column: Controls -->
            <div class="col-md-4">
                
                <!-- Profile Selection -->
                <div class="card p-3">
                    <h5 class="card-title">1. Select Profile</h5>
                    <select class="form-select mb-3" id="profileSelect">
                        <option value="" selected disabled>Choose GoLogin Profile...</option>
                        {% for profile in profiles %}
                        <option value="{{ profile.id }}">{{ profile.name }} ({{ profile.id[:6] }}...)</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Dark Panel (Growth) -->
                <div class="card p-3 border-start border-4 border-primary">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title m-0">üåë Dark Panel (Growth)</h5>
                    </div>
                    <p class="small text-muted">Targeted follow from `growth_config.py`</p>
                    <div class="mb-2">
                        <input type="text" id="growthTarget" class="form-control" placeholder="Target Username (e.g. zuck)">
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-primary" onclick="runWorker('growth')">Run Growth Once Now</button>
                    </div>
                </div>

                <!-- White Panel (Comment) -->
                <div class="card p-3 border-start border-4 border-info">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title m-0">‚ö™ White Panel (AI Comment)</h5>
                    </div>
                    <p class="small text-muted">Feed interaction from `comment_config.py`</p>
                    <div class="d-grid">
                        <button class="btn btn-info text-white" onclick="runWorker('comment')">Run Commenter Once Now</button>
                    </div>
                </div>

                <!-- Post Panel -->
                <div class="card p-3 border-start border-4 border-success">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title m-0">üì∏ Post Panel (Content Creator)</h5>
                    </div>
                    <p class="small text-muted">Upload photo + AI caption</p>
                    
                    <!-- Photo Upload Section -->
                    <div class="mb-2">
                        <label class="form-label small">Select Photo</label>
                        <input type="file" class="form-control form-control-sm" id="photoInput" accept="image/jpeg,image/png,image/webp,.jpg,.jpeg,.png,.webp" onchange="previewPhoto(event)">
                        <div class="form-text" style="font-size: 0.7rem;">Max 3 posts/day. Formats: JPG, PNG, WEBP</div>
                    </div>
                    
                    <!-- Topic/Hint Field -->
                    <div class="mb-2">
                        <label class="form-label small">Topic/Hint (optional)</label>
                        <input type="text" class="form-control form-control-sm" id="photoTopic" placeholder="e.g., nature, food, travel">
                        <div class="form-text" style="font-size: 0.7rem;">Help AI generate better caption</div>
                    </div>
                    
                    <!-- Photo Preview -->
                    <div id="photoPreview" class="mb-2" style="display: none;">
                        <img id="previewImage" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #dee2e6;">
                    </div>
                    
                    <!-- Action Button -->
                    <div class="d-grid">
                        <button class="btn btn-success" id="uploadPostBtn" onclick="uploadAndPost()" disabled>
                            üöÄ Upload & Post Now
                        </button>
                    </div>
                    
                    <div id="uploadStatus" class="mt-2" style="font-size: 0.75rem;"></div>
                </div>

                <!-- Scheduler -->
                <div class="card p-3 border-start border-4 border-warning">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title m-0">üìÖ Scheduler</h5>
                    </div>
                    <form id="schedulerForm">
                        <div class="mb-2">
                            <label class="form-label small">Task Type</label>
                            <select class="form-select form-select-sm" id="schedTaskType">
                                <option value="growth">Growth (Follow)</option>
                                <option value="comment">Comment (AI)</option>
                                <option value="post">Post (Photo + Caption)</option>
                            </select>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="form-label small">Count/Day</label>
                                <input type="number" class="form-control form-control-sm" id="schedCount" value="3" min="1">
                            </div>
                            <div class="col-3">
                                <label class="form-label small">Start Hr</label>
                                <input type="number" class="form-control form-control-sm" id="schedStart" value="9" min="0" max="23">
                            </div>
                            <div class="col-3">
                                <label class="form-label small">End Hr</label>
                                <input type="number" class="form-control form-control-sm" id="schedEnd" value="22" min="0" max="23">
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="button" class="btn btn-warning" onclick="scheduleTasks()">Plan Sessions</button>
                        </div>
                    </form>
                </div>

                <!-- Config Editors -->
                <div class="card p-3">
                    <h5 class="card-title">‚öôÔ∏è Configuration</h5>
                    <ul class="nav nav-tabs" id="configTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#growth-conf" type="button">Growth</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#comment-conf" type="button">Comment</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-2" id="configTabContent">
                        <div class="tab-pane fade show active" id="growth-conf" role="tabpanel">
                            <textarea class="form-control config-editor" id="growthConfigText">{{ growth_config }}</textarea>
                            <button class="btn btn-sm btn-outline-primary mt-2 w-100" onclick="saveConfig('growth_config.py', 'growthConfigText')">Save Growth Config</button>
                        </div>
                        <div class="tab-pane fade" id="comment-conf" role="tabpanel">
                            <textarea class="form-control config-editor" id="commentConfigText">{{ comment_config }}</textarea>
                            <button class="btn btn-sm btn-outline-primary mt-2 w-100" onclick="saveConfig('comment_config.py', 'commentConfigText')">Save Comment Config</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Logs & Status -->
            <div class="col-md-8">
                
                <!-- Statistics Dashboard -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card text-center p-2 border-success">
                            <div class="card-body p-2">
                                <h6 class="text-success mb-1">üì∏ Posts</h6>
                                <h3 class="mb-0" id="statPosts">0</h3>
                                <small class="text-muted">Today</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center p-2 border-primary">
                            <div class="card-body p-2">
                                <h6 class="text-primary mb-1">üë• Follows</h6>
                                <h3 class="mb-0" id="statFollows">0</h3>
                                <small class="text-muted">Today</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center p-2 border-info">
                            <div class="card-body p-2">
                                <h6 class="text-info mb-1">üí¨ Comments</h6>
                                <h3 class="mb-0" id="statComments">0</h3>
                                <small class="text-muted">Today</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center p-2 border-warning">
                            <div class="card-body p-2">
                                <h6 class="text-warning mb-1">‚ö° Active</h6>
                                <h3 class="mb-0" id="statActive">0</h3>
                                <small class="text-muted">Workers</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Live Logs -->
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <span>üìú Live Action Log (Last 50 actions)</span>
                        <div>
                            <small id="lastUpdate" class="text-muted me-2"></small>
                            <button class="btn btn-sm btn-outline-light" onclick="fetchLogs(); fetchStats();">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div class="log-box" id="logBox">
                        <div class="text-muted">Loading actions...</div>
                    </div>
                </div>

                <!-- Recent Sessions -->
                <div class="card">
                    <div class="card-header">üïí Recent Sessions (Last 50) - Click row for details</div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Profile</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Results</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in sessions %}
                                <tr style="cursor: pointer;" onclick="showSessionDetails('{{ session.session_id }}')">
                                    <td><small>{{ session.time }}</small></td>
                                    <td><strong>{{ session.profile_name }}</strong></td>
                                    <td>
                                        {% if session.type == 'Growth' %}
                                            <span class="badge bg-primary">Growth</span>
                                        {% elif session.type == 'Comment' %}
                                            <span class="badge bg-info">Comment</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ session.type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if session.status == 'running' %}
                                            <span class="badge bg-warning">Running</span>
                                        {% elif session.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ session.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>
                                            {% if session.follows > 0 %}
                                                <span class="text-primary">{{ session.follows }} follows</span>
                                            {% endif %}
                                            {% if session.comments > 0 %}
                                                <span class="text-info">{{ session.comments }} comments</span>
                                            {% endif %}
                                            {% if session.likes > 0 %}
                                                <span class="text-success">{{ session.likes }} likes</span>
                                            {% endif %}
                                            {% if session.errors > 0 %}
                                                <span class="text-danger">({{ session.errors }} errors)</span>
                                            {% endif %}
                                            {% if session.follows == 0 and session.comments == 0 and session.likes == 0 %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Details Modal -->
    <div class="modal fade" id="sessionModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sessionModalTitle">Session Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="sessionModalBody">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Actions
        async function runWorker(type) {
            const profileId = document.getElementById('profileSelect').value;
            if (!profileId) {
                alert('Please select a profile first!');
                return;
            }

            const formData = new FormData();
            formData.append('profile_id', profileId);

            if (type === 'growth') {
                const target = document.getElementById('growthTarget').value;
                if (!target) {
                    alert('Please enter a target username for Growth!');
                    return;
                }
                formData.append('target_username', target);
            }

            if (!confirm(`Start ${type.toUpperCase()} worker for ${profileId}?`)) return;

            try {
                const response = await fetch(`/api/run_${type}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                alert(result.message);
                if(result.status === 'success') location.reload();
            } catch (err) {
                alert('Error starting worker: ' + err);
            }
        }

        async function saveConfig(filename, elementId) {
            const content = document.getElementById(elementId).value;
            const formData = new FormData();
            formData.append('filename', filename);
            formData.append('content', content);

            try {
                const response = await fetch('/api/save_config', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                alert(result.message);
            } catch (err) {
                alert('Error saving config: ' + err);
            }
        }

        async function scheduleTasks() {
            const profileId = document.getElementById('profileSelect').value;
            if (!profileId) {
                alert('Please select a profile first!');
                return;
            }

            const taskType = document.getElementById('schedTaskType').value;
            const count = parseInt(document.getElementById('schedCount').value);
            const startHour = parseInt(document.getElementById('schedStart').value);
            const endHour = parseInt(document.getElementById('schedEnd').value);

            const payload = {
                profile_ids: [profileId],
                task_type: taskType,
                count: count,
                start_hour: startHour,
                end_hour: endHour
            };

            try {
                const response = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                alert(result.message);
            } catch (err) {
                alert('Error scheduling: ' + err);
            }
        }

        // Poll for Logs with enhanced formatting
        async function fetchLogs() {
            try {
                const res = await fetch('/api/logs');
                const logs = await res.json();
                const logBox = document.getElementById('logBox');
                
                if (logs.length === 0) {
                    logBox.innerHTML = '<div class="text-muted">No actions logged yet...</div>';
                    return;
                }

                // Action type icons
                const icons = {
                    'post': 'üì∏',
                    'follow': 'üë•',
                    'like': '‚ù§Ô∏è',
                    'comment': 'üí¨',
                    'growth': 'üå±'
                };

                logBox.innerHTML = logs.map(l => {
                    const time = new Date(l.time).toLocaleTimeString();
                    const colorClass = l.status === 'success' ? 'text-success' : (l.status === 'error' ? 'text-danger' : 'text-warning');
                    const statusIcon = l.status === 'success' ? '‚úÖ' : (l.status === 'error' ? '‚ùå' : '‚ö†Ô∏è');
                    
                    // Get action type for icon (split on arrow if present)
                    const actionType = l.action.split(' ')[0].toLowerCase();
                    const actionIcon = icons[actionType] || 'üîπ';
                    
                    return `<div style="padding: 4px 0; border-bottom: 1px solid #2a2a2a;">
                        <span class="text-secondary">[${time}]</span> 
                        <span>${actionIcon}</span>
                        <b>${l.profile}</b>: ${l.action} 
                        <span class="${colorClass}">${statusIcon}</span>
                        ${l.metadata ? '<br><span class="text-muted" style="padding-left: 120px; font-size: 0.8em;">'+l.metadata+'</span>' : ''}
                    </div>`;
                }).join('');
            } catch(e) {
                console.error(e);
            }
        }
        // Photo Upload Functions
        function previewPhoto(event) {
            const file = event.target.files[0];
            const uploadPostBtn = document.getElementById('uploadPostBtn');
            const preview = document.getElementById('photoPreview');
            const previewImage = document.getElementById('previewImage');
            const uploadStatus = document.getElementById('uploadStatus');
            
            if (file) {
                // Validate file type by extension (more reliable than MIME type)
                const fileName = file.name.toLowerCase();
                const validExtensions = ['.jpg', '.jpeg', '.png', '.webp'];
                const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
                
                if (!hasValidExtension) {
                    alert('Invalid file type. Please select JPG, PNG, or WEBP image.');
                    event.target.value = '';
                    uploadPostBtn.disabled = true;
                    preview.style.display = 'none';
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                    uploadPostBtn.disabled = false;
                    uploadStatus.innerHTML = '';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                uploadPostBtn.disabled = true;
            }
        }

        async function uploadAndPost() {
            const fileInput = document.getElementById('photoInput');
            const topicInput = document.getElementById('photoTopic');
            const profileSelect = document.getElementById('profileSelect');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadPostBtn = document.getElementById('uploadPostBtn');
            
            if (!profileSelect.value) {
                alert('Please select a profile first!');
                return;
            }
            
            if (!fileInput.files[0]) {
                alert('Please select a photo first!');
                return;
            }
            
            if (!confirm('Upload and post this photo now?')) return;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('profile_id', profileSelect.value);
            formData.append('topic', topicInput.value || '');
            
            try {
                uploadPostBtn.disabled = true;
                uploadStatus.innerHTML = '<span class="text-info">‚è≥ Uploading & Posting... This may take a minute...</span>';
                
                const response = await fetch('/api/upload_and_post', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    uploadStatus.innerHTML = '<span class="text-success">‚úÖ ' + result.message + '</span>';
                    // Clear inputs after success
                    setTimeout(() => {
                        fileInput.value = '';
                        topicInput.value = '';
                        document.getElementById('photoPreview').style.display = 'none';
                        uploadPostBtn.disabled = true;
                        uploadStatus.innerHTML = '';
                        location.reload(); // Refresh to show new session
                    }, 3000);
                } else {
                    uploadStatus.innerHTML = '<span class="text-danger">‚ùå ' + result.message + '</span>';
                    uploadPostBtn.disabled = false;
                }
            } catch (err) {
                uploadStatus.innerHTML = '<span class="text-danger">‚ùå Failed: ' + err + '</span>';
                uploadPostBtn.disabled = false;
            }
        }

        // Fetch and update statistics
        async function fetchStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                
                document.getElementById('statPosts').textContent = stats.today.posts;
                document.getElementById('statFollows').textContent = stats.today.follows;
                document.getElementById('statComments').textContent = stats.today.comments;
                document.getElementById('statActive').textContent = stats.active_workers;
                
                // Update last refresh time
                const now = new Date().toLocaleTimeString();
                document.getElementById('lastUpdate').textContent = `Updated: ${now}`;
            } catch(e) {
                console.error('Stats fetch failed:', e);
                document.getElementById('lastUpdate').textContent = 'Update failed';
            }
        }

        // Show session details in modal
        async function showSessionDetails(sessionId) {
            const modal = new bootstrap.Modal(document.getElementById('sessionModal'));
            const modalBody = document.getElementById('sessionModalBody');
            const modalTitle = document.getElementById('sessionModalTitle');
            
            // Show loading
            modalBody.innerHTML = `<div class="text-center"><div class="spinner-border" role="status"></div><p>Loading session details...</p></div>`;
            modal.show();
            
            try {
                const res = await fetch(`/api/session/${sessionId}`);
                const data = await res.json();
                
                if (data.status === 'error') {
                    modalBody.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                    return;
                }
                
                const session = data.session;
                const actions = data.actions;
                
                // Build modal content based on session type
                let content = `
                    <div class="mb-3">
                        <h6>Session Information</h6>
                        <p><strong>Profile:</strong> ${session.profile_name || session.profile_id}</p>
                        <p><strong>Started:</strong> ${session.started_at}</p>
                        <p><strong>Ended:</strong> ${session.ended_at || 'N/A'}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${session.status === 'completed' ? 'success' : 'warning'}">${session.status}</span></p>
                        <p><strong>Actions:</strong> ${session.actions_performed || 0}</p>
                    </div>
                    <hr>
                    <h6>Actions Performed (${actions.length})</h6>
                `;
                
                if (actions.length === 0) {
                    content += '<p class="text-muted">No actions recorded</p>';
                } else {
                    content += '<div class="list-group">';
                    actions.forEach(action => {
                        const statusBadge = action.status === 'success' ? 'success' : 'danger';
                        const icon = action.type === 'post' ? 'üì∏' : action.type === 'follow' ? 'üë•' : action.type === 'comment' ? 'üí¨' : action.type === 'like' ? '‚ù§Ô∏è' : 'üîπ';
                        
                        content += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="w-100">
                                        <h6 class="mb-1">${icon} ${action.type.toUpperCase()}</h6>
                                        ${action.target ? `<p class="mb-1"><strong>Target:</strong> ${action.target}</p>` : ''}
                                        ${action.metadata.text ? `<p class="mb-1"><em>"${action.metadata.text}"</em></p>` : ''}
                                        ${action.metadata.photo_filename ? `
                                            <p class="mb-2">üì∑ ${action.metadata.photo_filename}</p>
                                            <img src="/media/${action.metadata.photo_filename}" class="img-fluid rounded" style="max-width: 400px; max-height: 300px;" alt="Posted image">
                                        ` : ''}
                                    </div>
                                    <span class="badge bg-${statusBadge}">${action.status}</span>
                                </div>
                                <small class="text-muted">${action.time}</small>
                            </div>
                        `;
                    });
                    content += '</div>';
                }
                
                modalBody.innerHTML = content;
                modalTitle.textContent = `Session: ${session.profile_name || 'Unknown'}`;
                
            } catch (err) {
                modalBody.innerHTML = `<div class="alert alert-danger">Error loading session details: ${err}</div>`;
            }
        }

        // Initial load only - manual refresh via button
        fetchLogs();
        fetchStats();
    </script>
</body>
</html>
